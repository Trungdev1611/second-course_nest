# ============================================
# Docker Compose Configuration
# ============================================
# File n√†y ƒë·ªãnh nghƒ©a c√°c services: PostgreSQL, Redis, Elasticsearch, v√† NestJS Backend
#
# üìã C√ÅCH S·ª¨ D·ª§NG:
#
# 1Ô∏è‚É£ CHU·∫®N B·ªä:
#    - ƒê·∫£m b·∫£o ƒë√£ c√≥ file .env (copy t·ª´ .env.example n·∫øu ch∆∞a c√≥)
#    - File .env ch·ª©a c√°c bi·∫øn m√¥i tr∆∞·ªùng c·∫ßn thi·∫øt (xem .env.example)
#
# 2Ô∏è‚É£ CH·∫†Y T·∫§T C·∫¢ SERVICES:
#    docker-compose up -d
#    ‚Üí Kh·ªüi ƒë·ªông t·∫•t c·∫£ services ·ªü ch·∫ø ƒë·ªô background (detached mode)
#    ‚Üí Services s·∫Ω t·ª± ƒë·ªông ch·ªù nhau kh·ªüi ƒë·ªông nh·ªù healthcheck v√† depends_on
#
# 3Ô∏è‚É£ BUILD V√Ä CH·∫†Y (khi c√≥ thay ƒë·ªïi code):
#    docker-compose up -d --build
#    ‚Üí Build l·∫°i images v√† kh·ªüi ƒë·ªông services
#    ‚Üí D√πng khi c√≥ thay ƒë·ªïi trong Dockerfile ho·∫∑c code
#
# 4Ô∏è‚É£ XEM LOGS:
#    docker-compose logs -f                    # Xem logs t·∫•t c·∫£ services
#    docker-compose logs -f backend            # Xem logs ch·ªâ backend
#    docker-compose logs -f postgres           # Xem logs ch·ªâ postgres
#
# 5Ô∏è‚É£ D·ª™NG SERVICES:
#    docker-compose stop                       # D·ª´ng nh∆∞ng gi·ªØ containers
#    docker-compose down                       # D·ª´ng v√† x√≥a containers (gi·ªØ volumes)
#    docker-compose down -v                    # D·ª´ng v√† x√≥a c·∫£ volumes (‚ö†Ô∏è m·∫•t data!)
#
# 6Ô∏è‚É£ CH·∫†Y RI√äNG T·ª™NG SERVICE:
#    docker-compose up postgres                # Ch·ªâ ch·∫°y postgres
#    docker-compose up redis                   # Ch·ªâ ch·∫°y redis
#    docker-compose up elasticsearch           # Ch·ªâ ch·∫°y elasticsearch
#    docker-compose up backend                 # Ch·ªâ ch·∫°y backend
#
# 6Ô∏è‚É£.1 CH·∫†Y CH·ªà 3 SERVICES (PostgreSQL, Redis, Elasticsearch) - Backend ch·∫°y local:
#    docker-compose up -d postgres redis elasticsearch
#    ‚Üí Ch·∫°y ch·ªâ 3 containers, backend NestJS ch·∫°y local tr√™n m√°y
#    ‚Üí Backend local s·∫Ω k·∫øt n·ªëi qua localhost v·ªõi c√°c ports:
#       - PostgreSQL: localhost:3336 (ho·∫∑c POSTGRES_HOST_PORT trong .env)
#       - Redis: localhost:6379
#       - Elasticsearch: http://localhost:9200
#    ‚Üí Trong .env, c·∫ßn d√πng localhost thay v√¨ t√™n service:
#       DB_HOST=localhost (kh√¥ng ph·∫£i 'postgres')
#       REDIS_URL=redis://localhost:6379 (kh√¥ng ph·∫£i 'redis://redis:6379')
#       URL_ES_SEARCH=http://localhost:9200 (kh√¥ng ph·∫£i 'http://elasticsearch:9200')
#
# 7Ô∏è‚É£ REBUILD SERVICE C·ª§ TH·ªÇ:
#    docker-compose up -d --build backend       # Rebuild v√† restart backend
#
# 8Ô∏è‚É£ XEM TR·∫†NG TH√ÅI SERVICES:
#    docker-compose ps                         # Xem status c√°c containers
#    docker-compose top                        # Xem processes ƒëang ch·∫°y
#
# 9Ô∏è‚É£ TRUY C·∫¨P SERVICES:
#    - Backend API: http://localhost:3000 (ho·∫∑c PORT trong .env)
#    - PostgreSQL: localhost:3336 (ho·∫∑c POSTGRES_HOST_PORT trong .env)
#    - Redis: localhost:6379
#    - Elasticsearch: http://localhost:9200
#
# üîü C√ÅC L·ªÜNH KH√ÅC:
#    docker-compose restart backend            # Restart service backend
#    docker-compose exec backend sh            # V√†o shell c·ªßa backend container
#    docker-compose exec postgres psql -U postgres -d fullstack  # V√†o PostgreSQL
#
# üìù L∆ØU √ù:
#    - File .env KH√îNG ƒë∆∞·ª£c commit v√†o git (ƒë√£ c√≥ trong .gitignore)
#    - File .env.example l√† template, c√≥ th·ªÉ commit v√†o git
#    - Khi ch·∫°y trong Docker, c√°c services giao ti·∫øp qua t√™n service (postgres, redis, elasticsearch)
#    - URL_ES_SEARCH trong .env ph·∫£i d√πng 'elasticsearch' thay v√¨ 'localhost' khi ch·∫°y docker
#    - pull_policy: never ‚Üí KH√îNG pull images t·ª´ Docker Hub, ch·ªâ d√πng images local ƒë√£ c√≥
#      N·∫øu thi·∫øu image n√†o, c·∫ßn pull th·ªß c√¥ng: docker pull <image_name>
#
# ============================================

services:
  # ============================================
  # PostgreSQL Database Service
  # ============================================
  # Ch·∫°y ri√™ng: docker-compose up postgres
  # Xem logs: docker-compose logs -f postgres
  # Truy c·∫≠p: psql -h localhost -p 3336 -U postgres -d fullstack
  postgres:
    image: postgres:16
    pull_policy: if_not_present  # ‚úÖ KH√îNG pull t·ª´ hub khi local ho·∫∑c runner ƒë√£ c√≥
    container_name: second-course-nest-db
    environment:
      # ‚úÖ Updated: S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng t·ª´ .env file (n·∫øu kh√¥ng c√≥ th√¨ d√πng default)
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mysecretpassword}
      POSTGRES_DB: ${POSTGRES_DB:-fullstack}
    ports:
      # ‚úÖ Updated: Map port host:container (default host port: 3336, container port: 5432)
      # C√≥ th·ªÉ th√™m POSTGRES_HOST_PORT v√†o .env n·∫øu mu·ªën ƒë·ªïi port tr√™n host
      - "${POSTGRES_HOST_PORT:-3336}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      # ‚úÖ Updated: S·ª≠ d·ª•ng bi·∫øn POSTGRES_USER t·ª´ environment
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # ============================================
  # Redis Cache Service
  # ============================================
  # Ch·∫°y ri√™ng: docker-compose up redis
  # Xem logs: docker-compose logs -f redis
  # Truy c·∫≠p: redis-cli -h localhost -p 6379
  redis:
    image: redis:7.2-bookworm  # ‚úÖ D√πng image redis:7.2-bookworm ƒë√£ c√≥ local
    pull_policy: if_not_present  # ‚úÖ KH√îNG pull t·ª´ hub khi local ho·∫∑c runner ƒë√£ c√≥
    container_name: second-course-nest-redis
    command: redis-server --appendonly yes  # ‚úÖ Ch·∫°y Redis server v·ªõi persistence
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # ============================================
  # Elasticsearch Service
  # ============================================
  # Ch·∫°y ri√™ng: docker-compose up elasticsearch
  # Xem logs: docker-compose logs -f elasticsearch
  # Truy c·∫≠p: http://localhost:9200
  # Ki·ªÉm tra health: curl http://localhost:9200/_cluster/health
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    pull_policy: if_not_present  # ‚úÖ KH√îNG pull t·ª´ hub khi local ho·∫∑c runner ƒë√£ c√≥
    container_name: second-course-nest-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - app-network

  # ============================================
  # NestJS Backend Service
  # ============================================
  # Ch·∫°y ri√™ng: docker-compose up backend
  # Rebuild: docker-compose up -d --build backend
  # Xem logs: docker-compose logs -f backend
  # Restart: docker-compose restart backend
  # V√†o shell: docker-compose exec backend sh
  # Truy c·∫≠p API: http://localhost:3000 (ho·∫∑c PORT trong .env)
  # Swagger docs: http://localhost:3000/api/docs
  backend:
    build:
      context: .
      dockerfile: dockerfile
    container_name: second-course-nest-backend
    ports:
      # ‚úÖ Updated: S·ª≠ d·ª•ng PORT t·ª´ .env file (default: 3000)
      - "${PORT:-3001}:3001"  #N·∫øu .env c√≥ PORT, d√πng gi√° tr·ªã ƒë√≥, n·∫øu kh√¥ng th√¨ m·∫∑c ƒë·ªãnh l√† 3002.
    # ‚úÖ Updated: Load t·∫•t c·∫£ bi·∫øn t·ª´ .env file v√†o container
    env_file:
      - .env
    environment:
      # ‚úÖ Updated: S·ª≠ d·ª•ng c√°c bi·∫øn t·ª´ .env file v·ªõi gi√° tr·ªã default
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3001} 
      - PORT_DB=${PORT_DB:-5432}
      - DOMAIN=${DOMAIN:-http://localhost:3000}
      # ‚úÖ Updated: URL_ES_SEARCH t·ª´ .env (l∆∞u √Ω: trong docker network ph·∫£i d√πng 'elasticsearch' thay v√¨ 'localhost')
      # N·∫øu .env c√≥ URL_ES_SEARCH=http://localhost:9200, c·∫ßn ƒë·ªïi th√†nh http://elasticsearch:9200 khi ch·∫°y docker
      - URL_ES_SEARCH=${URL_ES_SEARCH:-http://elasticsearch:9200}
      # Database connection (using service name in docker network)
      # ‚úÖ Updated: S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng cho DB connection (c√≥ th·ªÉ th√™m v√†o .env sau)
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-mysecretpassword}
      - DB_DATABASE=${DB_DATABASE:-fullstack}
      # Redis connection
      # ‚úÖ Updated: S·ª≠ d·ª•ng bi·∫øn REDIS_URL t·ª´ .env (n·∫øu c√≥) ho·∫∑c default
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      # ‚úÖ Updated: C√°c bi·∫øn kh√°c t·ª´ .env s·∫Ω ƒë∆∞·ª£c load t·ª± ƒë·ªông qua env_file
      - jwtkey=${jwtkey}
      - APP_PASSWORD_GMAIL_SEND=${APP_PASSWORD_GMAIL_SEND}
      - GMAIL_SEND=${GMAIL_SEND}
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped

# ============================================
# Volumes Configuration
# ============================================
# Volumes l∆∞u tr·ªØ d·ªØ li·ªáu persistent (d·ªØ li·ªáu kh√¥ng m·∫•t khi container b·ªã x√≥a)
# Xem volumes: docker volume ls
# Xem chi ti·∫øt: docker volume inspect <volume_name>
# X√≥a volume: docker volume rm <volume_name> (‚ö†Ô∏è m·∫•t data!)
volumes:
  postgres_data:
    external: true
    name: 531aea41909a4ac673910ce8e6adf0b0a172e28b64b33817b721eb040f8edc44 # hash of the old postgres_data volume, because we want to reuse the old data
  redis_data:
  elasticsearch_data:

# ============================================
# Networks Configuration
# ============================================
# Network ƒë·ªÉ c√°c services giao ti·∫øp v·ªõi nhau
# Trong Docker network, c√°c services d√πng t√™n service ƒë·ªÉ giao ti·∫øp:
# - postgres (thay v√¨ localhost)
# - redis (thay v√¨ localhost)
# - elasticsearch (thay v√¨ localhost)
# Xem networks: docker network ls
# Xem chi ti·∫øt: docker network inspect <network_name>
networks:
  app-network:
    driver: bridge

