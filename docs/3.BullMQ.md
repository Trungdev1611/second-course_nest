# 3. BullMQ - Message Queue & Event-Driven Architecture

## üìö M·ª•c ti√™u h·ªçc t·∫≠p
- Hi·ªÉu v·ªÅ Message Queue v√† Event-Driven Architecture
- Implement BullMQ trong NestJS
- X·ª≠ l√Ω background jobs async
- Retry logic v√† error handling
- Queue monitoring v√† debugging

---

## üéØ T·ªïng quan v·ªÅ BullMQ

**BullMQ** l√† m·ªôt message queue system d·ª±a tr√™n Redis, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·∫∑c bi·ªát cho Node.js. N√≥ cho ph√©p x·ª≠ l√Ω c√°c c√¥ng vi·ªác n·ªÅn (background jobs) m·ªôt c√°ch async v√† reliable.

### T·∫°i sao c·∫ßn Message Queue?

**V·∫•n ƒë·ªÅ hi·ªán t·∫°i:**
- Email g·ª≠i ƒë·ªìng b·ªô ‚Üí l√†m ch·∫≠m API response
- Elasticsearch indexing ƒë·ªìng b·ªô ‚Üí block request
- Image processing ƒë·ªìng b·ªô ‚Üí user ph·∫£i ch·ªù l√¢u
- Heavy calculations ‚Üí l√†m ch·∫≠m server

**Gi·∫£i ph√°p v·ªõi Queue:**
- ‚úÖ API response nhanh (kh√¥ng ch·ªù job ho√†n th√†nh)
- ‚úÖ Retry t·ª± ƒë·ªông n·∫øu job fail
- ‚úÖ X·ª≠ l√Ω batch jobs
- ‚úÖ Scale workers ƒë·ªôc l·∫≠p
- ‚úÖ Monitor v√† debug d·ªÖ d√†ng

---

## üîÑ Lu·ªìng ho·∫°t ƒë·ªông chi ti·∫øt (Flow)

### Flow t·ª´ User API ‚Üí Bull Queue

#### B∆∞·ªõc 1: User g·ªçi API t·ª´ Frontend

```
Frontend (Browser)
    ‚Üì
POST /api/auth/register
Body: { email, username, password }
```

**V√≠ d·ª•:**
```typescript
// Frontend code
const response = await fetch('http://localhost:3000/api/auth/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    username: 'john_doe',
    password: 'password123'
  })
});
```

---

#### B∆∞·ªõc 2: Request ƒë·∫øn NestJS Controller

```
HTTP Request
    ‚Üì
AuthController.register()
```

**Code:**
```typescript
@Post('register')
registerAuth(@Body() createDto: CreateUserDTO) {
  return this.authService.register(createDto);
}
```

**Gi·∫£i th√≠ch:**
- `@Post('register')`: Route handler cho POST `/auth/register`
- `@Body() createDto`: NestJS t·ª± parse JSON body th√†nh `CreateUserDTO`
- G·ªçi `authService.register(createDto)`

---

#### B∆∞·ªõc 3: AuthService x·ª≠ l√Ω logic

```
AuthController
    ‚Üì
AuthService.register()
```

**Code (sau khi refactor v·ªõi Bull):**
```typescript
async register(dto: RegisterDto) {
  // 1. Hash password
  const hashedPassword = await bcrypt.hash(dto.password, 10);
  
  // 2. T·∫°o user trong database
  const user = await this.userRepository.save({
    email: dto.email,
    username: dto.username,
    password: hashedPassword,
  });
  
  // 3. Generate verification token
  const verifyToken = this.jwtService.sign(
    { userId: user.id },
    { expiresIn: '7d' }
  );
  
  // 4. T·∫°o verification link
  const verifyLink = `${process.env.APP_URL}/auth/verify-email?token=${verifyToken}`;
  
  // 5. ‚≠ê TH√äM JOB V√ÄO QUEUE (KH√îNG CH·ªú EMAIL G·ª¨I)
  await this.emailQueueService.sendVerificationEmail(
    user.email,
    user.username,
    verifyLink
  );
  
  // 6. Return user ngay l·∫≠p t·ª©c (kh√¥ng ch·ªù email g·ª≠i xong)
  return user;
}
```

**ƒêi·ªÉm quan tr·ªçng:**
- **Tr∆∞·ªõc khi c√≥ Bull:** `await this.emailService.sendEmail(...)` ‚Üí ph·∫£i ch·ªù email g·ª≠i xong (c√≥ th·ªÉ m·∫•t 2-5 gi√¢y)
- **Sau khi c√≥ Bull:** `await this.emailQueueService.sendVerificationEmail(...)` ‚Üí ch·ªâ th√™m job v√†o queue (m·∫•t < 10ms)

---

#### B∆∞·ªõc 4: EmailQueueService th√™m job v√†o queue

```
AuthService
    ‚Üì
EmailQueueService.sendVerificationEmail()
    ‚Üì
emailQueue.add()
```

**Code:**
```typescript
async sendVerificationEmail(email: string, name: string, verifyLink: string) {
  // ‚≠ê TH√äM JOB V√ÄO REDIS QUEUE
  await this.emailQueue.add(
    'send-verification',           // Job name
    { email, name, verifyLink },   // Job data
    {
      attempts: 3,                // Retry 3 l·∫ßn n·∫øu fail
      backoff: {
        type: 'exponential',
        delay: 2000,              // 2s, 4s, 8s...
      },
      removeOnComplete: true,     // X√≥a job sau khi complete
      removeOnFail: false,        // Gi·ªØ l·∫°i job failed
    }
  );
}
```

**ƒêi·ªÅu g√¨ x·∫£y ra:**
1. `this.emailQueue` l√† instance c·ªßa Queue (ƒë∆∞·ª£c inject t·ª´ `@InjectQueue('email')`)
2. `add()` t·∫°o job object v√† l∆∞u v√†o Redis
3. Job ƒë∆∞·ª£c l∆∞u trong Redis v·ªõi structure:
   ```json
   {
     "id": "job-123",
     "name": "send-verification",
     "data": {
       "email": "user@example.com",
       "name": "john_doe",
       "verifyLink": "http://..."
     },
     "opts": {
       "attempts": 3,
       "backoff": {...}
     },
     "timestamp": 1234567890,
     "status": "waiting"
   }
   ```
4. Method return ngay l·∫≠p t·ª©c (kh√¥ng ch·ªù job ƒë∆∞·ª£c x·ª≠ l√Ω)

---

#### B∆∞·ªõc 5: Redis l∆∞u job

```
EmailQueueService
    ‚Üì
Redis (In-memory database)
```

**Redis l∆∞u job trong c√°c keys:**
- `bull:email:waiting`: List ch·ª©a job IDs ƒëang ch·ªù x·ª≠ l√Ω
- `bull:email:123`: Hash ch·ª©a job data (id, name, data, opts, ...)
- `bull:email:meta`: Metadata v·ªÅ queue

**C·∫•u tr√∫c trong Redis:**
```
bull:email:waiting = [job-123, job-124, ...]
bull:email:123 = {
  id: "job-123",
  name: "send-verification",
  data: {...},
  opts: {...},
  timestamp: 1234567890
}
```

---

#### B∆∞·ªõc 6: EmailProcessor nh·∫≠n job (t·ª± ƒë·ªông)

```
Redis Queue
    ‚Üì
Bull checks for new jobs (polling)
    ‚Üì
EmailProcessor.handleSendVerification()
```

**Code:**
```typescript
@Processor('email')  // ‚≠ê ƒêƒÉng k√Ω processor cho queue 'email'
@Injectable()
export class EmailProcessor {
  constructor(private readonly emailService: EmailService) {}

  @Process('send-verification')  // ‚≠ê X·ª≠ l√Ω job name 'send-verification'
  async handleSendVerification(job: Job<{
    email: string;
    name: string;
    verifyLink: string;
  }>) {
    // 1. Extract data t·ª´ job
    const { email, name, verifyLink } = job.data;
    
    // 2. Log
    this.logger.log(`Processing email verification for ${email}`);
    
    // 3. Update progress
    await job.progress(50);
    
    // 4. G·ª¨I EMAIL (ƒë√¢y l√† ph·∫ßn ch·∫≠m)
    await this.emailService.sendEmail(
      email,
      name,
      verifyLink,
      'X√°c nh·∫≠n verify email t·ª´ Blog app'
    );
    
    // 5. Update progress
    await job.progress(100);
    
    // 6. Log success
    this.logger.log(`Email verification sent to ${email}`);
    
    // 7. Return result
    return { sent: true, email };
  }
}
```

**C√°ch ho·∫°t ƒë·ªông:**
1. **Bull polling:** Bull li√™n t·ª•c check Redis (m·ªói v√†i ms) xem c√≥ job m·ªõi kh√¥ng
2. **Khi c√≥ job m·ªõi** trong `bull:email:waiting`:
   - Bull l·∫•y job ra
   - Di chuy·ªÉn job t·ª´ `waiting` ‚Üí `active`
   - T√¨m processor c√≥ `@Process('send-verification')`
   - G·ªçi method `handleSendVerification()`
3. Method ch·∫°y async trong background (kh√¥ng block API)

---

#### B∆∞·ªõc 7: EmailService g·ª≠i email

```
EmailProcessor
    ‚Üì
EmailService.sendEmail()
    ‚Üì
SMTP Server (Gmail, SendGrid, ...)
```

**Code:**
```typescript
async sendEmail(to: string, name: string, verifyLink: string, subject: string) {
  await this.transporter.sendMail({
    from: `"Blog App" <${this.configService.get('GMAIL_SEND')}>`,
    to,
    subject: subject,
    html: `...email template...`
  });
}
```

**ƒêi·ªÅu g√¨ x·∫£y ra:**
- K·∫øt n·ªëi SMTP server (Gmail, SendGrid, ...)
- G·ª≠i email (c√≥ th·ªÉ m·∫•t 1-5 gi√¢y)
- N·∫øu th√†nh c√¥ng ‚Üí job completed
- N·∫øu fail ‚Üí Bull retry theo `attempts` v√† `backoff`

---

#### B∆∞·ªõc 8: Job ho√†n th√†nh

```
EmailService
    ‚Üì
Job completed
    ‚Üì
Redis update job status
```

**Sau khi email g·ª≠i th√†nh c√¥ng:**
1. `handleSendVerification()` return result
2. Bull c·∫≠p nh·∫≠t job status trong Redis:
   - `bull:email:123` ‚Üí status: "completed"
   - Di chuy·ªÉn job t·ª´ `active` ‚Üí `completed`
   - N·∫øu `removeOnComplete: true` ‚Üí x√≥a job kh·ªèi Redis
3. Job result ƒë∆∞·ª£c l∆∞u (c√≥ th·ªÉ query sau)

---

### üìä Timeline t·ªïng th·ªÉ

```
Time    | Action
--------|--------------------------------------------------
0ms     | User click "Register" button
50ms    | Request ƒë·∫øn NestJS server
100ms   | AuthController nh·∫≠n request
150ms   | AuthService.register() b·∫Øt ƒë·∫ßu
200ms   | User ƒë∆∞·ª£c t·∫°o trong database
250ms   | emailQueue.add() ƒë∆∞·ª£c g·ªçi
260ms   | Job ƒë∆∞·ª£c l∆∞u v√†o Redis
270ms   | emailQueue.add() return (API response)
280ms   | HTTP Response tr·∫£ v·ªÅ cho user (200 OK)
        |
        | ‚≠ê USER ƒê√É NH·∫¨N RESPONSE (ch∆∞a ƒë·∫øn 300ms!)
        |
300ms   | EmailProcessor nh·∫≠n job t·ª´ Redis
350ms   | EmailService b·∫Øt ƒë·∫ßu g·ª≠i email
2000ms  | Email g·ª≠i th√†nh c√¥ng (SMTP response)
2100ms  | Job completed, c·∫≠p nh·∫≠t Redis
```

**So s√°nh:**
- **Kh√¥ng c√≥ Bull:** User ph·∫£i ch·ªù 2-5 gi√¢y
- **C√≥ Bull:** User nh·∫≠n response trong < 300ms, email g·ª≠i sau

---

### üìà Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend  ‚îÇ
‚îÇ   (Browser) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ POST /api/auth/register
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Controller ‚îÇ  ‚Üê AuthController.register()
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Service   ‚îÇ  ‚Üê AuthService.register()
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚Üí Create user in DB
       ‚îÇ
       ‚îî‚îÄ‚Üí emailQueue.add() ‚îÄ‚îÄ‚îê
                              ‚îÇ
                              ‚Üì
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  Redis  ‚îÇ  ‚Üê Job stored
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚Üì (polling)
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  Processor ‚îÇ  ‚Üê EmailProcessor
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚Üì
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇEmail Service‚îÇ  ‚Üê Send email
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚Üì
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  SMTP   ‚îÇ
                         ‚îÇ Server  ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### üí° Gi·∫£i th√≠ch `job.progress()`

`job.progress()` d√πng ƒë·ªÉ c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô c·ªßa job (0-100%). Gi√∫p theo d√µi job ƒëang ·ªü b∆∞·ªõc n√†o, ƒë·∫∑c bi·ªát v·ªõi c√°c job ch·∫°y l√¢u.

#### C√°ch ho·∫°t ƒë·ªông:

**1. Gi√° tr·ªã l√† ph·∫ßn trƒÉm (0-100)**
```typescript
await job.progress(0);   // 0% - B·∫Øt ƒë·∫ßu
await job.progress(50);  // 50% - ƒêang x·ª≠ l√Ω
await job.progress(100); // 100% - Ho√†n th√†nh
```

**2. B·∫°n c√≥ th·ªÉ ƒë·∫∑t b·∫•t k·ª≥ s·ªë n√†o t·ª´ 0-100**
```typescript
await job.progress(25);   // 25% - ƒê√£ l√†m 1/4
await job.progress(33);   // 33% - ƒê√£ l√†m 1/3
await job.progress(66);   // 66% - ƒê√£ l√†m 2/3
await job.progress(75);   // 75% - ƒê√£ l√†m 3/4
await job.progress(100);  // 100% - Xong
```

**3. V√≠ d·ª•: Email Queue (ƒë∆°n gi·∫£n)**
```typescript
@Process('send-verification')
async handleSendVerification(job: Job) {
  const { email, name, verifyLink } = job.data;
  
  // 0% - B·∫Øt ƒë·∫ßu
  await job.progress(0);
  this.logger.log('Starting email send...');
  
  // 50% - ƒê√£ chu·∫©n b·ªã xong, ƒëang g·ª≠i
  await job.progress(50);
  await this.emailService.sendEmail(email, name, verifyLink);
  
  // 100% - G·ª≠i xong
  await job.progress(100);
  this.logger.log('Email sent successfully');
  
  return { sent: true };
}
```

**4. V√≠ d·ª•: Image Processing (c·∫ßn progress)**
```typescript
@Process('resize-image')
async handleResizeImage(job: Job<{
  imageUrl: string;
  sizes: number[];
}>) {
  const { imageUrl, sizes } = job.data;
  const totalSteps = sizes.length;
  const results = [];
  
  // 0% - B·∫Øt ƒë·∫ßu
  await job.progress(0);
  this.logger.log(`Resizing ${totalSteps} images...`);
  
  // Download image
  await job.progress(10);
  const imageBuffer = await downloadImage(imageUrl);
  
  // Resize t·ª´ng size
  for (let i = 0; i < sizes.length; i++) {
    const size = sizes[i];
    
    // T√≠nh progress: 10% (download) + (i/totalSteps) * 90%
    const progress = 10 + Math.floor((i / totalSteps) * 90);
    await job.progress(progress);
    
    // Resize image
    const resized = await sharp(imageBuffer)
      .resize(size, size)
      .toBuffer();
    
    // Upload l√™n Cloudinary
    const url = await uploadToCloudinary(resized);
    results.push({ size, url });
    
    this.logger.log(`Resized ${size}x${size} (${progress}%)`);
  }
  
  // 100% - Ho√†n th√†nh
  await job.progress(100);
  this.logger.log('All images resized successfully');
  
  return { results };
}
```

**5. Xem progress tr√™n Bull Board**

Khi truy c·∫≠p Bull Board (`http://localhost:3000/admin/queues`), b·∫°n s·∫Ω th·∫•y:

```
Queue: email
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Job ID: job-123                                 ‚îÇ
‚îÇ Name: send-verification                          ‚îÇ
‚îÇ Status: active                                  ‚îÇ
‚îÇ Progress: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 50%            ‚îÇ ‚Üê ƒê√¢y!
‚îÇ Started: 2 seconds ago                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**6. Khi n√†o c·∫ßn d√πng progress?**

‚úÖ **C·∫ßn d√πng:**
- Job ch·∫°y l√¢u (v√†i gi√¢y tr·ªü l√™n)
- Job x·ª≠ l√Ω nhi·ªÅu items (batch)
- Job c√≥ nhi·ªÅu b∆∞·ªõc r√µ r√†ng
- C·∫ßn theo d√µi ti·∫øn ƒë·ªô

‚ùå **Kh√¥ng c·∫ßn d√πng:**
- Job r·∫•t nhanh (< 1 gi√¢y)
- Job ƒë∆°n gi·∫£n, √≠t b∆∞·ªõc
- Kh√¥ng c·∫ßn theo d√µi ti·∫øn ƒë·ªô

**7. L∆∞u √Ω:**
- Progress kh√¥ng b·∫Øt bu·ªôc
- C√≥ th·ªÉ d√πng s·ªë th·∫≠p ph√¢n (nh∆∞ng Bull s·∫Ω l√†m tr√≤n)
- C√≥ th·ªÉ truy·ªÅn object thay v√¨ s·ªë (v·ªõi th√¥ng tin chi ti·∫øt)
- Progress ƒë∆∞·ª£c l∆∞u trong Redis, c√≥ th·ªÉ query t·ª´ code kh√°c

---

### üéØ L·ª£i √≠ch c·ªßa Flow n√†y

1. **API response nhanh:** User kh√¥ng ph·∫£i ch·ªù email g·ª≠i
2. **Reliability:** N·∫øu email service fail, Bull t·ª± ƒë·ªông retry
3. **Scalability:** C√≥ th·ªÉ ch·∫°y nhi·ªÅu workers ƒë·ªÉ x·ª≠ l√Ω nhi·ªÅu jobs song song
4. **Monitoring:** C√≥ th·ªÉ xem job status tr√™n Bull Board
5. **Decoupling:** Email service t√°ch bi·ªát v·ªõi API logic

---

## üìã C√°c Use Cases trong Project

### 1. Email Queue ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (∆Øu ti√™n cao nh·∫•t)

**Hi·ªán t·∫°i:** Email ƒëang g·ª≠i ƒë·ªìng b·ªô trong `EmailService`

**Use cases:**
- ‚úÖ G·ª≠i email verification khi ƒëƒÉng k√Ω
- ‚úÖ G·ª≠i email reset password
- ‚úÖ G·ª≠i email th√¥ng b√°o (comment, like, follow)
- ‚úÖ G·ª≠i email b√°o c√°o h√†ng tu·∫ßn/th√°ng
- ‚úÖ G·ª≠i email marketing (batch)

**L·ª£i √≠ch:**
- API response nhanh h∆°n (kh√¥ng ch·ªù email g·ª≠i xong)
- Retry t·ª± ƒë·ªông n·∫øu email service l·ªói
- C√≥ th·ªÉ x·ª≠ l√Ω h√†ng lo·∫°t (batch)
- Theo d√µi ƒë∆∞·ª£c tr·∫°ng th√°i g·ª≠i email

---

### 2. Elasticsearch Indexing Queue ‚≠ê‚≠ê‚≠ê‚≠ê

**Hi·ªán t·∫°i:** C√≥ th·ªÉ ƒëang index ƒë·ªìng b·ªô khi t·∫°o/s·ª≠a blog

**Use cases:**
- ‚úÖ Index blog m·ªõi v√†o Elasticsearch (async)
- ‚úÖ Re-index khi blog ƒë∆∞·ª£c update
- ‚úÖ Batch re-index to√†n b·ªô blogs
- ‚úÖ X√≥a index khi blog b·ªã x√≥a

**L·ª£i √≠ch:**
- Kh√¥ng block API khi index
- C√≥ th·ªÉ retry n·∫øu Elasticsearch l·ªói
- X·ª≠ l√Ω batch ƒë·ªÉ t·ªëi ∆∞u performance

---

### 3. Image Processing Queue ‚≠ê‚≠ê‚≠ê‚≠ê

**Hi·ªán t·∫°i:** C√≥ th·ªÉ ƒëang upload ·∫£nh tr·ª±c ti·∫øp l√™n Cloudinary

**Use cases:**
- ‚úÖ Resize ·∫£nh th√†nh nhi·ªÅu k√≠ch th∆∞·ªõc (thumbnail, medium, large)
- ‚úÖ Optimize ·∫£nh (compress, format conversion)
- ‚úÖ Generate blur placeholder cho lazy loading
- ‚úÖ X·ª≠ l√Ω ·∫£nh avatar khi upload

**L·ª£i √≠ch:**
- Upload nhanh, x·ª≠ l√Ω sau
- C√≥ th·ªÉ retry n·∫øu x·ª≠ l√Ω l·ªói
- X·ª≠ l√Ω nhi·ªÅu ·∫£nh song song

---

### 4. Notification Queue ‚≠ê‚≠ê‚≠ê

**Hi·ªán t·∫°i:** C√≥ `NotificationService` v√† `NotificationEntity`

**Use cases:**
- ‚úÖ T·∫°o notification khi c√≥ comment m·ªõi
- ‚úÖ T·∫°o notification khi c√≥ like
- ‚úÖ T·∫°o notification khi c√≥ follow request
- ‚úÖ G·ª≠i push notification (n·∫øu c√≥ mobile app)
- ‚úÖ Batch notification cho nhi·ªÅu users

**L·ª£i √≠ch:**
- Kh√¥ng block API response
- C√≥ th·ªÉ batch notifications
- Retry n·∫øu l·ªói

---

### 5. Analytics & Statistics Queue ‚≠ê‚≠ê‚≠ê

**Hi·ªán t·∫°i:** C√≥ cron job flush views t·ª´ Redis v√†o DB

**Use cases:**
- ‚úÖ T√≠nh to√°n trending posts (async)
- ‚úÖ T√≠nh to√°n user statistics
- ‚úÖ T√≠nh to√°n daily/weekly/monthly reports
- ‚úÖ Update view counts, like counts (batch)

**L·ª£i √≠ch:**
- Kh√¥ng l√†m ch·∫≠m API
- C√≥ th·ªÉ schedule jobs
- X·ª≠ l√Ω heavy calculations m√† kh√¥ng block

---

### 6. Cache Warming Queue ‚≠ê‚≠ê

**Use cases:**
- ‚úÖ Pre-cache popular posts v√†o Redis
- ‚úÖ Pre-cache user profiles
- ‚úÖ Pre-cache tag lists
- ‚úÖ Warm up cache khi server restart

**L·ª£i √≠ch:**
- Cache s·∫µn s√†ng tr∆∞·ªõc khi user request
- C·∫£i thi·ªán response time

---

## üöÄ Implementation Plan

### Step 1: C√†i ƒë·∫∑t Dependencies

```bash
npm install @nestjs/bull bull
npm install @bull-board/express @bull-board/api
npm install --save-dev @types/bull
```

### Step 2: C·∫•u h√¨nh Bull Module

**File: `src/queue/queue.module.ts`**
```typescript
import { Module } from '@nestjs/common';
import { BullModule } from '@nestjs/bull';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { EmailProcessor } from './email/email.processor';
import { ElasticsearchProcessor } from './elasticsearch/elasticsearch.processor';
import { ImageProcessor } from './image/image.processor';

@Module({
  imports: [
    BullModule.forRootAsync({
      imports: [ConfigModule],
      useFactory: async (configService: ConfigService) => ({
        redis: {
          host: configService.get('REDIS_HOST', 'localhost'),
          port: configService.get('REDIS_PORT', 6379),
        },
      }),
      inject: [ConfigService],
    }),
    BullModule.registerQueue(
      { name: 'email' },
      { name: 'elasticsearch' },
      { name: 'image' },
      { name: 'notification' },
      { name: 'analytics' },
    ),
  ],
  providers: [
    EmailProcessor,
    ElasticsearchProcessor,
    ImageProcessor,
  ],
  exports: [BullModule],
})
export class QueueModule {}
```

### Step 3: T·∫°o Email Queue Processor

**File: `src/queue/email/email.processor.ts`**
```typescript
import { Processor, Process, OnQueueFailed } from '@nestjs/bull';
import { Job } from 'bull';
import { Injectable, Logger } from '@nestjs/common';
import { EmailService } from '../../email/email.service';

@Processor('email')
@Injectable()
export class EmailProcessor {
  private readonly logger = new Logger(EmailProcessor.name);

  constructor(private readonly emailService: EmailService) {}

  @Process('send-verification')
  async handleSendVerification(job: Job<{
    email: string;
    name: string;
    verifyLink: string;
  }>) {
    const { email, name, verifyLink } = job.data;
    
    this.logger.log(`Processing email verification for ${email}`);
    
    await job.progress(50);
    
    await this.emailService.sendEmail(
      email,
      name,
      verifyLink,
      'X√°c nh·∫≠n verify email t·ª´ Blog app'
    );
    
    await job.progress(100);
    this.logger.log(`Email verification sent to ${email}`);
    
    return { sent: true, email };
  }

  @Process('send-reset-password')
  async handleSendResetPassword(job: Job<{
    email: string;
    name: string;
    resetLink: string;
  }>) {
    const { email, name, resetLink } = job.data;
    
    await this.emailService.sendEmailResetPassword(
      email,
      name,
      resetLink
    );
    
    return { sent: true, email };
  }

  @Process('send-notification')
  async handleSendNotification(job: Job<{
    email: string;
    subject: string;
    content: string;
  }>) {
    const { email, subject, content } = job.data;
    
    // Implement notification email logic
    await this.emailService.sendEmail(
      email,
      'User',
      content,
      subject
    );
    
    return { sent: true, email };
  }

  @OnQueueFailed()
  async onFailed(job: Job, error: Error) {
    this.logger.error(
      `Job ${job.id} failed: ${error.message}`,
      error.stack
    );
    // C√≥ th·ªÉ log v√†o Sentry ho·∫∑c database
  }
}
```

**File: `src/queue/email/email.module.ts`**
```typescript
import { Module } from '@nestjs/common';
import { EmailProcessor } from './email.processor';
import { EmailModule as AppEmailModule } from '../../email/email.module';

@Module({
  imports: [AppEmailModule],
  providers: [EmailProcessor],
})
export class EmailQueueModule {}
```

### Step 4: T·∫°o Email Queue Service

**File: `src/queue/email/email-queue.service.ts`**
```typescript
import { Injectable } from '@nestjs/common';
import { InjectQueue } from '@nestjs/bull';
import { Queue } from 'bull';

@Injectable()
export class EmailQueueService {
  constructor(
    @InjectQueue('email') private readonly emailQueue: Queue,
  ) {}

  async sendVerificationEmail(email: string, name: string, verifyLink: string) {
    await this.emailQueue.add(
      'send-verification',
      { email, name, verifyLink },
      {
        attempts: 3, // Retry 3 l·∫ßn
        backoff: {
          type: 'exponential',
          delay: 2000, // Delay 2s, 4s, 8s...
        },
        removeOnComplete: true, // X√≥a job sau khi ho√†n th√†nh
        removeOnFail: false, // Gi·ªØ l·∫°i job failed ƒë·ªÉ debug
      }
    );
  }

  async sendResetPasswordEmail(email: string, name: string, resetLink: string) {
    await this.emailQueue.add(
      'send-reset-password',
      { email, name, resetLink },
      {
        attempts: 3,
        backoff: {
          type: 'exponential',
          delay: 2000,
        },
      }
    );
  }

  async sendNotificationEmail(email: string, subject: string, content: string) {
    await this.emailQueue.add(
      'send-notification',
      { email, subject, content },
      {
        attempts: 2,
        backoff: {
          type: 'fixed',
          delay: 5000,
        },
      }
    );
  }
}
```

### Step 5: Refactor AuthService ƒë·ªÉ d√πng Queue

**File: `src/auth/auth.service.ts`** (Update)
```typescript
import { EmailQueueService } from '../queue/email/email-queue.service';

@Injectable()
export class AuthService {
  constructor(
    // ... existing dependencies
    private readonly emailQueueService: EmailQueueService,
  ) {}

  async register(dto: RegisterDto) {
    // ... existing registration logic
    
    const user = await this.userRepository.save(newUser);
    
    // Thay v√¨ g·ª≠i email tr·ª±c ti·∫øp:
    // await this.emailService.sendEmail(...)
    
    // D√πng queue (async, non-blocking):
    const verifyLink = `${process.env.APP_URL}/auth/verify-email?token=${verifyToken}`;
    await this.emailQueueService.sendVerificationEmail(
      user.email,
      user.username,
      verifyLink
    );
    
    return user;
  }

  async forgotPassword(email: string) {
    // ... existing logic
    
    // D√πng queue:
    const resetLink = `${process.env.APP_URL}/auth/reset-password?token=${resetToken}`;
    await this.emailQueueService.sendResetPasswordEmail(
      user.email,
      user.username,
      resetLink
    );
  }
}
```

### Step 6: Setup Bull Board (Dashboard ƒë·ªÉ monitor)

**File: `src/queue/bull-board.module.ts`**
```typescript
import { Module } from '@nestjs/common';
import { BullModule } from '@nestjs/bull';
import { createBullBoard } from '@bull-board/api';
import { BullAdapter } from '@bull-board/api/bullAdapter';
import { ExpressAdapter } from '@bull-board/express';

@Module({
  imports: [BullModule],
})
export class BullBoardModule {
  static forRoot() {
    const serverAdapter = new ExpressAdapter();
    serverAdapter.setBasePath('/admin/queues');

    createBullBoard({
      queues: [
        new BullAdapter(BullModule.getQueue('email')),
        new BullAdapter(BullModule.getQueue('elasticsearch')),
        new BullAdapter(BullModule.getQueue('image')),
        new BullAdapter(BullModule.getQueue('notification')),
        new BullAdapter(BullModule.getQueue('analytics')),
      ],
      serverAdapter,
    });

    return {
      module: BullBoardModule,
      providers: [],
      exports: [],
    };
  }
}
```

**File: `src/main.ts`** (Update)
```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ExpressAdapter } from '@bull-board/express';
import { createBullBoard } from '@bull-board/api';
import { BullAdapter } from '@bull-board/api/bullAdapter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Setup Bull Board
  const serverAdapter = new ExpressAdapter();
  serverAdapter.setBasePath('/admin/queues');

  const { addQueue, removeQueue, setQueues, replaceQueues } = createBullBoard({
    queues: [
      // Queues s·∫Ω ƒë∆∞·ª£c add sau khi app kh·ªüi ƒë·ªông
    ],
    serverAdapter,
  });

  app.use('/admin/queues', serverAdapter.getRouter());

  await app.listen(3000);
}
bootstrap();
```

---

## üìä Queue Configuration Options

### Job Options

```typescript
{
  attempts: 3,              // S·ªë l·∫ßn retry
  backoff: {
    type: 'exponential',    // exponential, fixed
    delay: 2000,            // Delay gi·ªØa c√°c retry (ms)
  },
  delay: 5000,              // Delay tr∆∞·ªõc khi process job
  priority: 1,              // Priority (cao h∆°n = process tr∆∞·ªõc)
  removeOnComplete: true,   // X√≥a job sau khi complete
  removeOnFail: false,      // Gi·ªØ l·∫°i job failed
  timeout: 30000,           // Timeout cho job (ms)
}
```

### Queue Options

```typescript
BullModule.registerQueue({
  name: 'email',
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 2000,
    },
  },
  settings: {
    stalledInterval: 30000,  // Check stalled jobs m·ªói 30s
    maxStalledCount: 1,      // Max stalled count tr∆∞·ªõc khi fail
  },
})
```

---

## üîç Monitoring & Debugging

### 1. Bull Board Dashboard

Truy c·∫≠p: `http://localhost:3000/admin/queues`

**Features:**
- Xem t·∫•t c·∫£ queues v√† jobs
- Xem job status (waiting, active, completed, failed)
- Retry failed jobs manually
- Xem job data v√† logs
- Clear queues

### 2. Queue Metrics

```typescript
// L·∫•y th√¥ng tin queue
const queue = this.emailQueue;

const waiting = await queue.getWaitingCount();
const active = await queue.getActiveCount();
const completed = await queue.getCompletedCount();
const failed = await queue.getFailedCount();

console.log({
  waiting,
  active,
  completed,
  failed,
});
```

### 3. Job Progress Tracking

```typescript
@Process('long-running-job')
async handleLongJob(job: Job) {
  const totalSteps = 100;
  
  for (let i = 0; i < totalSteps; i++) {
    // Do work...
    await job.progress((i / totalSteps) * 100);
  }
  
  return { completed: true };
}
```

---

## üéì Learning Outcomes

Sau khi implement BullMQ, b·∫°n s·∫Ω hi·ªÉu:

1. **Producer/Consumer Pattern**
   - Producer: Th√™m jobs v√†o queue
   - Consumer: X·ª≠ l√Ω jobs t·ª´ queue

2. **Job Scheduling & Retry Logic**
   - C√°ch schedule jobs
   - Retry strategies (exponential backoff, fixed delay)
   - Error handling

3. **Queue Monitoring & Debugging**
   - Bull Board dashboard
   - Queue metrics
   - Job status tracking

4. **Performance Optimization**
   - Async processing
   - Batch processing
   - Worker scaling

5. **Event-Driven Architecture**
   - Decouple services
   - Async communication
   - Reliability v√† fault tolerance

---

## üìù Next Steps

Sau khi implement Email Queue th√†nh c√¥ng:

1. ‚úÖ **Elasticsearch Indexing Queue** - Index blogs async
2. ‚úÖ **Image Processing Queue** - Resize v√† optimize images
3. ‚úÖ **Notification Queue** - Async notifications
4. ‚úÖ **Analytics Queue** - Background calculations

---

## üîó Resources

- **Official Docs:** https://docs.bullmq.io/
- **NestJS Bull Module:** https://docs.nestjs.com/techniques/queues
- **Bull Board:** https://github.com/felixmosh/bull-board

---

**Ch√∫c b·∫°n h·ªçc t·∫≠p th√†nh c√¥ng! üöÄ**

