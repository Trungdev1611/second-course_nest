# 12. Environment Variables Setup

## üìö M·ª•c ti√™u
- Hi·ªÉu c√°ch qu·∫£n l√Ω environment variables cho local v√† production
- Setup c√°c file .env ph√π h·ª£p v·ªõi t·ª´ng m√¥i tr∆∞·ªùng
- B·∫£o m·∫≠t sensitive data

---

## üéØ C√°ch ho·∫°t ƒë·ªông

### Th·ª© t·ª± ∆∞u ti√™n file .env

NestJS `ConfigModule` s·∫Ω ƒë·ªçc c√°c file theo th·ª© t·ª± sau (file sau s·∫Ω override file tr∆∞·ªõc):

1. `.env.${NODE_ENV}.local` - V√≠ d·ª•: `.env.development.local`, `.env.production.local`
2. `.env.${NODE_ENV}` - V√≠ d·ª•: `.env.development`, `.env.production`
3. `.env.local` - File cho local development (kh√¥ng ph·ª• thu·ªôc NODE_ENV)
4. `.env` - File fallback chung

**V√≠ d·ª•:**
- N·∫øu `NODE_ENV=development` ‚Üí ƒë·ªçc: `.env.development.local` ‚Üí `.env.development` ‚Üí `.env.local` ‚Üí `.env`
- N·∫øu `NODE_ENV=production` ‚Üí ƒë·ªçc: `.env.production.local` ‚Üí `.env.production` ‚Üí `.env.local` ‚Üí `.env`

---

## üìÅ C·∫•u tr√∫c file .env

### 1. `.env.example` (Template - commit v√†o git)

File n√†y ch·ª©a template v·ªõi t·∫•t c·∫£ c√°c bi·∫øn c·∫ßn thi·∫øt, kh√¥ng c√≥ gi√° tr·ªã th·ª±c t·∫ø.

```env
# Application
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3000

# Database
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=your-password
DB_DATABASE=fullstack

# JWT
jwtkey=your-secret-key

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# Email
GMAIL_SEND=your-email@gmail.com
APP_PASSWORD_GMAIL_SEND=your-app-password

# Cloudinary
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

# Elasticsearch
ELASTICSEARCH_NODE=http://localhost:9200

# Frontend
FRONTEND_URL=http://localhost:3001
```

---

### 2. `.env.local` (Local Development - KH√îNG commit)

File n√†y d√πng cho development local c·ªßa b·∫°n.

```bash
# Copy t·ª´ .env.example
cp .env.example .env.local

# Ho·∫∑c t·∫°o m·ªõi
touch .env.local
```

**N·ªôi dung:**
```env
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3000

DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=mysecretpassword
DB_DATABASE=fullstack

jwtkey=local-dev-secret-key

REDIS_HOST=localhost
REDIS_PORT=6379

GMAIL_SEND=your-email@gmail.com
APP_PASSWORD_GMAIL_SEND=your-app-password

CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

ELASTICSEARCH_NODE=http://localhost:9200

FRONTEND_URL=http://localhost:3001
```

---

### 3. `.env.production` (Production - KH√îNG commit)

File n√†y d√πng cho production server.

```bash
# Tr√™n production server
cp .env.example .env.production
# Sau ƒë√≥ edit v√† ƒëi·ªÅn gi√° tr·ªã production
```

**N·ªôi dung:**
```env
NODE_ENV=production
PORT=3000
APP_URL=https://your-domain.com

DB_HOST=your-production-db-host
DB_PORT=5432
DB_USERNAME=your-db-username
DB_PASSWORD=your-secure-db-password
DB_DATABASE=your-db-name

jwtkey=your-super-secure-production-jwt-key-min-32-chars

REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

GMAIL_SEND=your-production-email@gmail.com
APP_PASSWORD_GMAIL_SEND=your-production-app-password

CLOUDINARY_CLOUD_NAME=your-production-cloud-name
CLOUDINARY_API_KEY=your-production-api-key
CLOUDINARY_API_SECRET=your-production-api-secret

ELASTICSEARCH_NODE=https://your-elasticsearch-host:9200
ELASTICSEARCH_USERNAME=your-es-username
ELASTICSEARCH_PASSWORD=your-es-password

FRONTEND_URL=https://your-frontend-domain.com
```

---

### 4. `.env.development` (Optional - cho team)

N·∫øu b·∫°n mu·ªën c√≥ file chung cho team development:

```env
# Shared development config cho c·∫£ team
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3000

# Database chung (n·∫øu c√≥)
DB_HOST=dev-db-server
DB_PORT=5432
DB_USERNAME=dev_user
DB_PASSWORD=dev_password
DB_DATABASE=fullstack_dev

# ... c√°c config kh√°c
```

---

## üöÄ Setup cho Local Development

### B∆∞·ªõc 1: T·∫°o file .env.local

```bash
# Copy t·ª´ .env.example
cp .env.example .env.local

# Ho·∫∑c t·∫°o m·ªõi
touch .env.local
```

### B∆∞·ªõc 2: ƒêi·ªÅn c√°c gi√° tr·ªã th·ª±c t·∫ø

M·ªü `.env.local` v√† ƒëi·ªÅn c√°c gi√° tr·ªã:

```env
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3000

DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=your-actual-password
DB_DATABASE=fullstack

jwtkey=your-local-secret-key

REDIS_HOST=localhost
REDIS_PORT=6379

# ... ƒëi·ªÅn c√°c gi√° tr·ªã kh√°c
```

### B∆∞·ªõc 3: Ch·∫°y app

```bash
npm run start:dev
```

App s·∫Ω t·ª± ƒë·ªông ƒë·ªçc `.env.local` (v√¨ NODE_ENV=development m·∫∑c ƒë·ªãnh).

---

## üöÄ Setup cho Production

### Option 1: T·∫°o file .env.production tr√™n server

```bash
# SSH v√†o production server
ssh user@your-server.com

# T·∫°o file .env.production
nano .env.production

# ƒêi·ªÅn c√°c gi√° tr·ªã production
# ...

# Set NODE_ENV
export NODE_ENV=production

# Ch·∫°y app
npm run start:prod
```

### Option 2: D√πng Environment Variables tr·ª±c ti·∫øp (Recommended)

Tr√™n production, t·ªët h∆°n l√† set environment variables tr·ª±c ti·∫øp (kh√¥ng d√πng file .env):

**Docker:**
```dockerfile
# dockerfile
ENV NODE_ENV=production
ENV PORT=3000
# ... c√°c env kh√°c
```

**Docker Compose:**
```yaml
services:
  app:
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=postgres
      # ... c√°c env kh√°c
```

**PM2:**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'blog-api',
    script: './dist/main.js',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
      DB_HOST: 'your-db-host',
      // ... c√°c env kh√°c
    }
  }]
};
```

**CI/CD (GitHub Actions, GitLab CI, etc.):**
```yaml
# .github/workflows/deploy.yml
env:
  NODE_ENV: production
  PORT: 3000
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  # ... c√°c secrets kh√°c
```

---

## üîí B·∫£o m·∫≠t

### ‚úÖ N√™n l√†m:

1. **Commit `.env.example` v√†o git** (template kh√¥ng c√≥ gi√° tr·ªã th·ª±c)
2. **KH√îNG commit `.env.local`, `.env.production`** (ƒë√£ c√≥ trong .gitignore)
3. **D√πng secrets trong CI/CD** thay v√¨ hardcode
4. **Rotate secrets ƒë·ªãnh k·ª≥** (ƒë·∫∑c bi·ªát l√† JWT key, DB password)
5. **D√πng strong passwords** cho production

### ‚ùå Kh√¥ng n√™n l√†m:

1. ‚ùå Commit file `.env` c√≥ gi√° tr·ªã th·ª±c v√†o git
2. ‚ùå Hardcode secrets trong code
3. ‚ùå Share `.env` files qua email/chat
4. ‚ùå D√πng c√πng secrets cho dev v√† production

---

## üìù Checklist

### Local Development:
- [ ] Copy `.env.example` ‚Üí `.env.local`
- [ ] ƒêi·ªÅn c√°c gi√° tr·ªã local
- [ ] Test app ch·∫°y ƒë∆∞·ª£c
- [ ] Verify `.env.local` kh√¥ng commit v√†o git

### Production:
- [ ] Setup environment variables tr√™n server
- [ ] Set `NODE_ENV=production`
- [ ] Verify t·∫•t c·∫£ secrets ƒë√£ ƒë∆∞·ª£c set
- [ ] Test app ch·∫°y ƒë∆∞·ª£c tr√™n production
- [ ] Setup monitoring/logging

---

## üõ†Ô∏è Troubleshooting

### V·∫•n ƒë·ªÅ: App kh√¥ng ƒë·ªçc ƒë∆∞·ª£c .env

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra file `.env.local` c√≥ t·ªìn t·∫°i kh√¥ng
2. Ki·ªÉm tra `NODE_ENV` c√≥ ƒë√∫ng kh√¥ng
3. Ki·ªÉm tra `ConfigModule` trong `app.module.ts` c√≥ ƒë√∫ng config kh√¥ng
4. Restart app

### V·∫•n ƒë·ªÅ: Gi√° tr·ªã kh√¥ng ƒë√∫ng

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra th·ª© t·ª± ∆∞u ti√™n file .env
2. File sau s·∫Ω override file tr∆∞·ªõc
3. X√≥a cache: `rm -rf dist` v√† rebuild

### V·∫•n ƒë·ªÅ: Production kh√¥ng ƒë·ªçc ƒë∆∞·ª£c env

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra environment variables c√≥ ƒë∆∞·ª£c set tr√™n server kh√¥ng
2. Ki·ªÉm tra `NODE_ENV=production`
3. Ki·ªÉm tra Docker/PM2 config
4. Xem logs ƒë·ªÉ debug

---

## üìö Tham kh·∫£o

- [NestJS ConfigModule Docs](https://docs.nestjs.com/techniques/configuration)
- [dotenv Best Practices](https://github.com/motdotla/dotenv#best-practices)

---

**Ch√∫c b·∫°n setup th√†nh c√¥ng! üöÄ**

